<div id="assinatura-form">
    <form>
        <div>
            <label for="modelo"><strong>Selecione o Modelo de Assinatura:</strong></label>
            <select id="modelo">
                <option value="original">Assinatura DRE</option>
                <option value="novo">Assinatura Escola</option>
            </select>
        </div>

        <div id="modelo-original-campos">
            <label for="nome_original">Nome: <input type="text" id="nome_original" placeholder="Digite seu nome completo"
                    aria-label="Digite seu nome completo"></label>
            <label for="setor_original">Cargo / Setor: <input type="text" id="setor_original" value="NTIC / DREMP"></label>
            <label for="email_original">E-mail: <input type="email" id="email_original" value="TESTE@sme.prefeitura.sp.gov.br"></label>
            <label for="telefone_original">Telefone(s): <input type="text" id="telefone_original"
                    value="55 11 3397-XXXX | 55 11 3397-YYYY"></label>
            <label for="endereco_original">Endereço | Andar | Sala: <input type="text" id="endereco_original"
                    value="Av. Nordestina, 747 | 2º Andar | 226"></label>
            <label for="cep_original">CEP | Cidade | Estado: <input type="text" id="cep_original"
                    value="08021-000 | São Paulo | SP"></label>
            <label for="link1_original">Link 1: <input type="url" id="link1_original" value="educacao.sme.prefeitura.sp.gov.br"></label>
            <label for="link2_original">Link 2: <input type="url" id="link2_original"
                    placeholder="Digite um segundo link, caso necessário"
                    aria-label="Digite um segundo link, caso necessário"></label>
            <input type="hidden" id="imagem_original" value="https://dresaomiguel.com.br/wp-content/uploads/2025/05/SME_SP.png">
        </div>

        <div id="modelo-novo-campos" style="display: none;">
            <label for="nome_novo">Nome Completo: <input type="text" id="nome_novo"
                    placeholder="Digite seu nome completo" aria-label="Digite seu nome completo"></label>
            <label for="setor_novo">Cargo: <input type="text" id="setor_novo" value="Secretário Escolar"></label>
            <label for="email_novo">E-mail: <input type="email" id="email_novo"
                    value="TESTE@sme.prefeitura.sp.gov.br"></label>
            <label for="telefone_novo">Telefone(s): <input type="text" id="telefone_novo"
                    value="55 11 3397-XXXX | 55 11 3397-YYYY"></label>
            <label for="escola_novo">Escola / DRE: <input type="text" id="escola_novo"
                    value="EMEF Joaquim José da Silva Xavier / DREMP"></label>
            <label for="endereco_novo">Endereço | Andar | Sala: <input type="text" id="endereco_novo"
                    value="Av. Nordestina, 747 | 2º Andar | 226"></label>
            <label for="cep_novo">CEP | Cidade | Estado: <input type="text" id="cep_novo"
                    value="08021-000 | São Paulo | SP"></label>
            <label for="link1_novo">Link 1: <input type="url" id="link1_novo"
                    value="educacao.sme.prefeitura.sp.gov.br"></label>
            <label for="link2_novo">Link 2: <input type="url" id="link2_novo"
                    placeholder="Digite um segundo link, caso necessário"
                    aria-label="Digite um segundo link, caso necessário"></label>
            <input type="hidden" id="logo_novo" value="https://dresaomiguel.com.br/wp-content/uploads/2025/05/SME_SP.png">
        </div>

        <button type="button" id="gerar">Gerar Assinatura</button>
        <button type="button" id="copiar">Copiar HTML</button>
        <button type="button" id="baixar">Baixar Imagem</button>
    </form>

    <div id="assinatura">
        <div id="shadowHost"></div>
    </div>
</div>

<style>
#assinatura-form {
    font-family: Arial;
    max-width: 100%;
}

label {
    display: block;
    margin: 10px 0 5px;
}

input {
    width: 100%;
    padding: 5px;
    box-sizing: border-box;
}

button {
    margin: 10px 5px 0 0;
    padding: 10px 20px;
    cursor: pointer;
}

#assinatura {
    margin-top: 30px;
    padding: 10px;
    border-top: 1px solid #ccc;
}

#shadowHost {
    width: 100%;
    max-width: 450px;
    min-height: 100px;
    background: #fff;
    padding: 10px;
    box-sizing: border-box;
}

@keyframes spin {
    0% {
        transform: rotate(0deg);
    }

    100% {
        transform: rotate(360deg);
    }
}

@media (max-width: 600px) {
    #assinatura-form {
        padding: 10px;
    }

    button {
        width: 100%;
        margin-bottom: 10px;
    }
}
</style>

<script>
(function() {
    // Obtém o elemento shadow root onde a assinatura será renderizada.
    const shadowRoot = document.getElementById('shadowHost').attachShadow({
        mode: 'open'
    });

    // Variável para armazenar o HTML da assinatura gerada
    let generatedSignatureHtml = '';

    // Obtém os elementos dos campos de entrada para os diferentes modelos de assinatura.
    const modeloOriginalCampos = document.getElementById('modelo-original-campos');
    const modeloNovoCampos = document.getElementById('modelo-novo-campos');
    const modeloSelect = document.getElementById('modelo');
    const gerarButton = document.getElementById('gerar');
    const copiarButton = document.getElementById('copiar');
    const baixarButton = document.getElementById('baixar');

    // Adiciona um listener para o evento de mudança no select de modelo de assinatura.
    modeloSelect.addEventListener('change', () => {
        // Exibe os campos de entrada corretos com base no modelo de assinatura selecionado.
        if (modeloSelect.value === 'original') {
            modeloOriginalCampos.style.display = 'block';
            modeloNovoCampos.style.display = 'none';
        } else {
            modeloOriginalCampos.style.display = 'none';
            modeloNovoCampos.style.display = 'block';
        }
    });

    /**
     * Garante que a URL esteja completa, adicionando o protocolo 'https://' se necessário.
     * @param {string} url - A URL a ser corrigida.
     * @returns {string} A URL corrigida.
     */
    const corrigirUrl = (url) => url && !/^https?:\/\//i.test(url) ? 'https://' + url : url;

    /**
     * Valida os campos do formulário com base no modelo de assinatura selecionado.
     * @param {string} modelo - O modelo de assinatura selecionado ('original' ou 'novo').
     * @returns {boolean} True se o formulário for válido, false caso contrário.
     */
    function validarFormulario(modelo) {
        // Regex para validação de telefone no formato 55 XX YYYYY-YYYY ou 55 XX YYYY-YYYY,
        // com opcional | e outro número no mesmo formato.
        const phoneRegex = /^55\s\d{2}\s\d{4,5}-\d{4}(?:\s\|\s55\s\d{2}\s\d{4,5}-\d{4})?$/;

        if (modelo === 'original') {
            const nomeOriginal = document.getElementById('nome_original').value.trim();
            const setorOriginal = document.getElementById('setor_original').value.trim();
            const emailOriginal = document.getElementById('email_original').value.trim();
            const telefoneOriginal = document.getElementById('telefone_original').value.trim();

            if (!nomeOriginal) {
                alert('O campo "Nome" é obrigatório.');
                return false;
            }
            if (!setorOriginal) {
                alert('O campo "Cargo / Setor" é obrigatório.');
                return false;
            }

            if (setorOriginal.includes('/')) {
                const setores = setorOriginal.split('/').map(s => s.trim());
                if (
                    setores.length < 2 ||
                    setores.some(s => s === '') ||
                    setorOriginal.startsWith('/') ||
                    setorOriginal.endsWith('/')
                ) {
                    alert('O campo "Cargo / Setor" deve conter elementos válidos antes e depois da barra.');
                    return false;
                }
            } else {
                // Aceita apenas um termo simples, sem espaços
                if (/\s/.test(setorOriginal)) {
                    alert('Se for inserir apenas um item no campo "Cargo / Setor", ele não deve conter espaços.');
                    return false;
                }
            }

            if (!emailOriginal || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailOriginal)) {
                alert('Por favor, insira um e-mail válido.');
                return false;
            }
            // APLICAÇÃO DA NOVA REGEX
            if (telefoneOriginal && !phoneRegex.test(telefoneOriginal)) {
                alert('Por favor, insira um telefone válido no formato: 55 XX YYYYY-YYYY ou 55 XX YYYY-YYYY. Para dois números, use: 55 XX YYYYY-YYYY | 55 XX YYYYY-YYYY.');
                return false;
            }
            return true;
        } else if (modelo === 'novo') {
            const nomeNovo = document.getElementById('nome_novo').value.trim();
            const setorNovo = document.getElementById('setor_novo').value.trim();
            const emailNovo = document.getElementById('email_novo').value.trim();
            const telefoneNovo = document.getElementById('telefone_novo').value.trim();

            if (!nomeNovo) {
                alert('O campo "Nome" é obrigatório.');
                return false;
            }
            if (!setorNovo) {
                alert('O campo "Cargo" é obrigatório.');
                return false;
            }
            // Validação para o campo "Cargo" no modelo novo (se for cargo único, não deve ter barra)
            if (setorNovo.includes('/')) {
                alert('O campo "Cargo" não deve conter barras, pois é para um único cargo.');
                return false;
            }

            if (!emailNovo || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailNovo)) {
                alert('Por favor, insira um e-mail válido.');
                return false;
            }
            // APLICAÇÃO DA NOVA REGEX
            if (telefoneNovo && !phoneRegex.test(telefoneNovo)) {
                alert('Por favor, insira um telefone válido no formato: 55 XX YYYYY-YYYY ou 55 XX YYYY-YYYY. Para dois números, use: 55 XX YYYYY-YYYY | 55 XX YYYYY-YYYY.');
                return false;
            }
            return true;
        }
        return false;
    }

    /**
     * Valida se uma URL é válida.
     * @param {string} url - A URL a ser validada.
     * @returns {boolean} True se a URL for válida, false caso contrário.
     */
    function validarLinks(url) {
        try {
            new URL(url);
            return true;
        } catch {
            return false;
        }
    }

    /**
     * Exibe um spinner de carregamento.
     */
    function mostrarSpinner() {
        const spinner = document.createElement('div');
        spinner.id = 'spinner';
        spinner.style.position = 'fixed';
        spinner.style.top = '50%';
        spinner.style.left = '50%';
        spinner.style.transform = 'translate(-50%, -50%)';
        spinner.style.border = '4px solid #ccc';
        spinner.style.borderTop = '4px solid #000';
        spinner.style.borderRadius = '50%';
        spinner.style.width = '40px';
        spinner.style.height = '40px';
        spinner.style.animation = 'spin 1s linear infinite';
        document.body.appendChild(spinner);
    }

    /**
     * Remove o spinner de carregamento.
     */
    function removerSpinner() {
        const spinner = document.getElementById('spinner');
        if (spinner) {
            document.body.removeChild(spinner);
        }
    }

    /**
     * Gera o HTML da assinatura com base nos dados do formulário.
     * @returns {void}
     */
    function gerarAssinatura() {
        const modeloSelecionado = modeloSelect.value;

        if (!validarFormulario(modeloSelecionado)) return;

        let nome, setor, email, telefone, endereco, cep, link1, link2, imagem, escola;

        if (modeloSelecionado === 'original') {
            nome = document.getElementById('nome_original').value.trim().toUpperCase();
            setor = document.getElementById('setor_original').value.trim();
            email = document.getElementById('email_original').value.trim();
            telefone = document.getElementById('telefone_original').value.trim();
            endereco = document.getElementById('endereco_original').value.trim();
            cep = document.getElementById('cep_original').value.trim();
            link1 = corrigirUrl(document.getElementById('link1_original').value.trim());
            link2 = corrigirUrl(document.getElementById('link2_original').value.trim());
            imagem = document.getElementById('imagem_original').value.trim();
        } else if (modeloSelecionado === 'novo') {
            nome = document.getElementById('nome_novo').value.trim().toUpperCase();
            setor = document.getElementById('setor_novo').value.trim();
            email = document.getElementById('email_novo').value.trim();
            telefone = document.getElementById('telefone_novo').value.trim();
            endereco = document.getElementById('endereco_novo').value.trim();
            cep = document.getElementById('cep_novo').value.trim();
            link1 = corrigirUrl(document.getElementById('link1_novo').value.trim());
            link2 = corrigirUrl(document.getElementById('link2_novo').value.trim());
            imagem = document.getElementById('logo_novo').value.trim();
            escola = document.getElementById('escola_novo').value.trim();
        }

        if (link1 && !validarLinks(link1)) {
            alert('O Link 1 é inválido. Por favor, insira uma URL válida.');
            return;
        }

        if (link2 && !validarLinks(link2)) {
            alert('O Link 2 é inválido. Por favor, insira uma URL válida.');
            return;
        }

        let linksHTML = '';
        if (link1) {
            linksHTML +=
                `<div style="margin: 0; padding: 0; font-size: 8px; line-height: 1.2;"><a href="${link1}" target="_blank" style="text-decoration: none; color: inherit;">${new URL(link1).hostname}</a></div>`;
        }
        if (link2) {
            linksHTML +=
                `<div style="margin: 0; padding: 0; font-size: 8px; line-height: 1.2;"><a href="${link2}" target="_blank" style="text-decoration: none; color: inherit;">${new URL(link2).hostname}</a></div>`;
        }

        const imagemHTML = imagem ?
            `<img src="${imagem}" width="120" style="display: block; border: 0;" border="0" alt="Logo">` :
            '';

        // Estilo base para o conteúdo da célula de texto
        const tdContentStyle = `
            padding-left: 7px;
            border-left: 3px solid #000;
            vertical-align: middle;
            line-height: 1; /* Colapsa o line-height para o TD */
            font-family: Arial, sans-serif; /* Aplica a fonte ao TD */
            color: #000;
        `;

        let escolaHTML = '';
        if (modeloSelecionado === 'novo') {
            escolaHTML = `<div style="margin: 0; padding: 0; font-size: 8px; line-height: 1.2;">${escola}</div>`;
        }

        // HTML da assinatura com estrutura de tabela
        const htmlAssinatura = `
            <table cellpadding="0" cellspacing="0" border="0" style="background: #fff; width: 100%; max-width: 450px; font-family: Arial, sans-serif;">
                <tr>
                    <td valign="middle" style="padding: 10px; width: 120px; vertical-align: middle;">
                        ${imagemHTML}
                    </td>
                    <td valign="middle" style="${tdContentStyle}">
                        ${nome ? `<div style="margin: 0; padding: 0; font-size: 16px; text-transform: uppercase; line-height: 1.2;"><strong style="font-size: inherit;">${nome}</strong></div>` : ''}
                        ${setor ? `<div style="margin: 0; padding: 0; font-size: 7px; text-transform: uppercase; line-height: 1.2;">${setor}</div>` : ''}
                        <div style="margin: 0; padding: 0; font-size: 7px; line-height: 1.2; color:#FFFFFF;">_</div>
                        ${email ? `<div style="margin: 0; padding: 0; font-size: 8px; line-height: 1.2;"><a href="mailto:${email}" style="text-decoration: none; color: inherit;">${email}</a></div>` : ''}
                        ${telefone ? `<div style="margin: 0; padding: 0; font-size: 8px; line-height: 1.2;">Tel.: ${telefone}</div>` : ''}
                        ${escolaHTML}
                        ${endereco ? `<div style="margin: 0; padding: 0; font-size: 8px; line-height: 1.2;">${endereco}</div>` : ''}
                        ${cep ? `<div style="margin: 0; padding: 0; font-size: 8px; line-height: 1.2;">${cep}</div>` : ''}
                        ${linksHTML}
                    </td>
                </tr>
            </table>
        `;

        shadowRoot.innerHTML = htmlAssinatura;
        generatedSignatureHtml = htmlAssinatura; // Armazena o HTML gerado para cópia
    }

    /**
    * Copia o HTML da assinatura gerada para a área de transferência, formatado para Outlook.
    * @returns {void}
    */
    function copiarHTML() {
        // Verifica se a assinatura foi gerada
        if (!generatedSignatureHtml) {
            alert('Por favor, gere a assinatura primeiro.');
            return;
        }

        // Cria um elemento div temporário para segurar o HTML
        const tempDiv = document.createElement('div');
        tempDiv.style.position = 'absolute';
        tempDiv.style.left = '-9999px'; // Move para fora da tela
        tempDiv.style.top = '-9999px';
        tempDiv.innerHTML = generatedSignatureHtml; // Define o innerHTML com o HTML da assinatura armazenado
        document.body.appendChild(tempDiv); // Anexa ao corpo do documento

        // Seleciona o conteúdo do div temporário
        const range = document.createRange();
        range.selectNodeContents(tempDiv); // Seleciona todo o conteúdo
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);

        // Executa o comando de cópia
        try {
            document.execCommand('copy');
            const feedback = document.createElement('div');
            feedback.textContent = 'HTML copiado! Cole no Outlook.';
            feedback.style.position = 'fixed';
            feedback.style.bottom = '20px';
            feedback.style.right = '20px';
            feedback.style.backgroundColor = '#4CAF50';
            feedback.style.color = '#fff';
            feedback.style.padding = '10px';
            feedback.style.borderRadius = '5px';
            feedback.style.zIndex = '1000';
            document.body.appendChild(feedback);

            setTimeout(() => document.body.removeChild(feedback), 3000);
        } catch (err) {
            console.error('Erro ao copiar HTML:', err);
            alert('Não foi possível copiar o HTML. Por favor, tente novamente ou copie manualmente.');
        } finally {
            // Limpa: remove o div temporário e a seleção
            document.body.removeChild(tempDiv);
            selection.removeAllRanges();
        }
    }


    /**
     * Baixa a assinatura gerada como uma imagem JPG.
     * @returns {void}
     */
    function baixarImagem() {
        if (typeof html2canvas === 'undefined') {
            alert(
                'Erro: A biblioteca html2canvas não foi carregada. Verifique sua conexão ou tente novamente.'
            );
            return;
        }

        mostrarSpinner();
        const modeloSelecionado = modeloSelect.value;
        let nomeArquivo = 'assinatura';
        // Atualizado para selecionar a tabela recém-criada
        let elementoParaCapturar = shadowRoot.querySelector('table');

        if (!elementoParaCapturar) {
            removerSpinner();
            alert('Erro ao encontrar o elemento da assinatura para baixar.');
            return;
        }

        if (modeloSelecionado === 'original') {
            nomeArquivo = document.getElementById('nome_original').value.trim().replace(/\s+/g, '_') ||
                'assinatura_original';
            nomeArquivo += '_DRE';
        } else if (modeloSelecionado === 'novo') {
            nomeArquivo = document.getElementById('nome_novo').value.trim().replace(/\s+/g, '_') ||
                'assinatura_novo';
            nomeArquivo += '_Escola';
        }

        const tempContainer = document.createElement('div');
        tempContainer.style.position = 'fixed';
        tempContainer.style.top = '-9999px';
        tempContainer.style.left = '-9999px';
        tempContainer.style.background = '#fff';
        tempContainer.style.transformOrigin = 'top left';
        tempContainer.style.scale = '1';

        // Anexar o clone da tabela ao tempContainer
        tempContainer.appendChild(elementoParaCapturar.cloneNode(true));
        document.body.appendChild(tempContainer);

        const scaleFactor = window.devicePixelRatio || 2;
        const width = elementoParaCapturar.offsetWidth;
        const height = elementoParaCapturar.offsetHeight;

        html2canvas(tempContainer.firstChild, { // Capturar o primeiro filho, que é a tabela
                useCORS: true,
                backgroundColor: '#ffffff',
                scale: scaleFactor,
                width: width,
                height: height,
                windowWidth: width * scaleFactor,
                windowHeight: height * scaleFactor,
            })
            .then((bigCanvas) => {
                const finalCanvas = document.createElement('canvas');
                finalCanvas.width = width;
                finalCanvas.height = height;

                const finalCanvasContext = finalCanvas.getContext('2d');
                finalCanvasContext.drawImage(bigCanvas, 0, 0, bigCanvas.width, bigCanvas.height, 0, 0,
                    finalCanvas.width,
                    finalCanvas.height);

                const link = document.createElement('a');
                link.download = `${nomeArquivo}.jpg`;
                link.href = finalCanvas.toDataURL('image/jpeg', 0.9);

                link.click();

                document.body.removeChild(tempContainer);
                removerSpinner();
            })
            .catch((err) => {
                removerSpinner();
                console.error('Erro ao gerar imagem:', err);
                alert('Erro ao gerar a imagem. Tente novamente.');
            });
    }

    // Adiciona listeners de evento aos botões para gerar, copiar e baixar a assinatura.
    gerarButton.addEventListener('click', gerarAssinatura);
    copiarButton.addEventListener('click', copiarHTML);
    baixarButton.addEventListener('click', baixarImagem);

    // Carrega a biblioteca html2canvas de forma assíncrona.
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
    script.async = true;
    document.body.appendChild(script);
})();
</script>
